/*
Easy Photo Album Wordpress plugin javascript.
Copyright (C) 2013  TV productions
Licenced under GNU GPL 3, see <http://www.gnu.org/licenses/>.
*/
if(!String.prototype.format){String.prototype.format=function(){var e=arguments;return this.replace(/{(\d+)}/g,function(t,n){return typeof e[n]!="undefined"?e[n]:t})}}window.TVproductions=window.TVproductions||{};(function(e,t,n){var r=null;var i=function(){if(e.maxOrder<1){t(".easy-photo-album-table .row-actions .order_up, .easy-photo-album-table .row-actions .order_down").hide()}else{t("#the-list .column-image").each(function(n,r){$row=f(r);order=s(u(r));if(order<=0){t(".row-actions .order_up",$row).hide()}else if(order>=e.maxOrder){t(".row-actions .order_down",$row).hide();t(".row-actions .order_up",$row).html(t(".row-actions .order_up",$row).html().replace(" | ",""))}else{t(".row-actions .order_down, .row-actions .order_up",$row).show();if(t(".row-actions .order_up",$row).html().indexOf("|")===-1){t(".row-actions .order_up",$row).append(" | ")}}})}};var s=function(n){return parseInt(t('input[name="'+e.settingName+"["+n+'][order]"]').val())};var o=function(n){var r=t('input[value="'+n+'"][type="hidden"][name*="'+e.settingName+'["]').attr("name");var i=/[0-9]+/;return i.exec(r)[0]};var u=function(e){$row=f(e);return t("input[type=checkbox]",$row).val()};var a=function(e){return f('input[type=checkbox][value="'+e+'"]')};var f=function(e){return t(e).closest("tr")};var l=function(e,r,i){var s=o(i);var u=a(s);var f=a(r);if(t.isEmptyObject(u)||t.isEmptyObject(f)){return}var l=u.html();var h=f.html();if(l==n||h==n){console.error("Easy Photo Album: HTML Undefined Error");return}u.html(c(h,e,i));f.html(c(l,i,e))};var c=function(e,t,n){return e.replace('value="'+t+'"','value="'+n+'"')};var h=function(n,r){t('input[name="'+e.settingName+"["+n+'][order]"]').val(r)};var p=function(){setTimeout(function(){t(".order_up a.epa-move-up").click(function(t){if(t.target.tagName.toLowerCase()=="a")e.moveUp(this);t.preventDefault()});t(".order_down a.epa-move-down").click(function(t){if(t.target.tagName.toLowerCase()=="a")e.moveDown(this);t.preventDefault()});t(".delete a").click(function(t){if(t.target.tagName.toLowerCase()=="a")e.deletePhoto(this);t.preventDefault()});t('input[name="'+e.settingName+'[add_photo]"]').click(function(t){e.addPhoto(this);t.preventDefault()});t("easy-photo-album-table tbody tr").not(".alternate").css({"background-color":"#F9F9F9"})},50)};var d=function(n){return t('input[type="text"][name="'+e.settingName+"["+n+'][title]"]').val()};e.moveUp=function(e){var t=u(e);var n=s(t);if(n<=0)return;var r=n-1;l(n,t,r);i();p()};e.moveDown=function(t){var n=u(t);var r=s(n);if(r>=e.maxOrder)return;var o=r+1;l(r,n,o);i();p()};e.addPhoto=function(s){if(!r){if(!wp.media){console.error("Easy Photo Album: Wordpress media files not included or loaded correctly. Uploads disabled.");return}r=wp.media({title:e.lang.mediatitle,button:{text:e.lang.mediabutton},library:{type:"image"},multiple:true,frame:"select"});r.on("select",function(){var s=r.state().get("selection");s.map(function(r){var i=r.toJSON();var s=e.maxOrder+=1;var o=_.template(e.rowtemplate,{alternate:s%2===0?' class="alternate"':"",id:i.id,imgurl:i.sizes.thumbnail==n?i.sizes.full.url:i.sizes.thumbnail.url,order:s,title:i.title,caption:i.caption});t(".easy-photo-album-table tr:last").after(o)});i();p()},this)}wp.media.model.settings.post.id=t("#post_ID").val();r.open()};e.deletePhoto=function(t){var n=u(t);if(n&&confirm(e.lang.deleteconfirm.format(d(n)))){var r=s(n);var a=f(t);a.remove();e.maxOrder-=1;for(var l=r;l<=e.maxOrder;l++){var c=o(l+1);h(c,l)}p();i()}};(function(){if(e.settingName==n){console.info("EasyPhotoAlbum: settingName not set, use default");e.settingName="EasyPhotoAlbums"}if(e.maxOrder==n){console.info("EasyPhotoAlbum: maxOrder not set, calculate value");e.maxOrder=t("#the-list tr").length}i();p();t(".easy-photo-album-table tbody").sortable({axis:"y",handle:".column-image img",placeholder:"sortable-placeholder",forcePlaceholderSize:true,cursor:"move",opacity:.6,update:function(e,n){jQuery(".easy-photo-album-table tbody tr").each(function(e,t){h(u(t),e)});t(".easy-photo-album-table tr:nth-child(odd)").addClass("alternate");t(".easy-photo-album-table tr:nth-child(even)").removeClass("alternate");i();p()}})})()})(window.TVproductions.EasyPhotoAlbum=window.TVproductions.EasyPhotoAlbum||{},jQuery)